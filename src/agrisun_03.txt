// Combined: AP web dashboard + 2x AHT20/BMP280 (via TCA9548A) + OLED + RTC + Fans (PWM)
// + RFID (MFRC522) + solenoid unlocking + Serial & web logging

#include <WiFi.h>
#include <Wire.h>
#include <SPI.h>
#include <Adafruit_AHTX0.h>
#include <Adafruit_BMP280.h>
#include <Adafruit_SH110X.h>
#include <RTClib.h>
#include <WebServer.h>
#include <MFRC522.h>

#ifndef WHITE
#define WHITE 1
#endif

// Display / I2C / TCA
#define SCREEN_WIDTH 128
#define SCREEN_HEIGHT 64
#define OLED_RESET -1
#define OLED_ADDR 0x3C
#define TCA_ADDR 0x70

// Wi-Fi AP credentials
const char* ssid = "Deke";
const char* password = "12345678";

// Fan pins
#define FAN1_PIN 25  // inlet
#define FAN2_PIN 26  // outlet

// Thresholds
#define TEMP_THRESHOLD 35.0
#define HUM_THRESHOLD 60.0

// PWM setup
const int freq = 5000;
const int fanChannel1 = 0;
const int fanChannel2 = 1;
const int resolution = 8; // 0–255 duty cycle

// RFID (MFRC522) SPI pins - adjust if your wiring differs
#define SS_PIN 5     // SDA / SS pin for RC522
#define RST_PIN 27   // RST pin for RC522 or 22

// Solenoid lock pin (driven via MOSFET/relay input)
#define SOL_PIN 14
const unsigned long UNLOCK_DURATION_MS = 5000; // unlock time in ms

Adafruit_SH1106G display(SCREEN_WIDTH, SCREEN_HEIGHT, &Wire, OLED_RESET);
Adafruit_AHTX0 aht;
Adafruit_BMP280 bmp;
RTC_DS3231 rtc;
WebServer server(80);
MFRC522 mfrc522(SS_PIN, RST_PIN);

struct SensorData {
  float temp;
  float hum;
  float press;
  String timeStr;
};
SensorData sensors[2];

unsigned long fan1Start = 0, fan2Start = 0;
bool fan1On = false, fan2On = false;

// Solenoid / RFID state
bool solenoidActive = false;
unsigned long solenoidStart = 0;
String lastTagUID = "None";
String lastTagResult = "None";
unsigned long lastTagTime = 0;

// Authorized UIDs (add tag UIDs here in same format displayed by serial e.g. "DE:AD:BE:EF:12:34")
const char* authorizedUIDs[] = {
  "3B:07:92:5F", // :12:34",
  // add more here
};
const int AUTH_COUNT = sizeof(authorizedUIDs) / sizeof(authorizedUIDs[0]);

void tcaSelect(uint8_t channel) {
  if (channel > 7) return;
  Wire.beginTransmission(TCA_ADDR);
  Wire.write(1 << channel);
  Wire.endTransmission();
}

void startSolenoid() {
  digitalWrite(SOL_PIN, HIGH); // energize solenoid (change if your driver is active-low)
  solenoidActive = true;
  solenoidStart = millis();
  Serial.printf("Solenoid ON for %lus\n", UNLOCK_DURATION_MS / 1000);
}
void stopSolenoid() {
  digitalWrite(SOL_PIN, LOW);
  solenoidActive = false;
  unsigned long dur = (millis() - solenoidStart) / 1000;
  Serial.printf("Solenoid OFF. Duration: %lus\n", dur);
}

void controlFans() {
  float maxTemp = max(sensors[0].temp, sensors[1].temp);
  float maxHum  = max(sensors[0].hum, sensors[1].hum);

  // Fan 1 by temperature
  if (maxTemp > TEMP_THRESHOLD) {
    if (!fan1On) {
      fan1On = true;
      fan1Start = millis();
      Serial.printf("Temperature above %.1f°C! Fan 1 ON\n", TEMP_THRESHOLD);
    }
    int speed = map((int)round(maxTemp * 10), (int)round(TEMP_THRESHOLD * 10), (int)round((TEMP_THRESHOLD + 10)*10), 128, 255);
    speed = constrain(speed, 128, 255);
    ledcWrite(fanChannel1, speed);
  } else if (fan1On) {
    fan1On = false;
    ledcWrite(fanChannel1, 0);
    unsigned long duration = (millis() - fan1Start) / 1000;
    Serial.printf("Temperature normalized. Fan 1 OFF. Duration: %lus\n", duration);
  }

  // Fan 2 by humidity
  if (maxHum > HUM_THRESHOLD) {
    if (!fan2On) {
      fan2On = true;
      fan2Start = millis();
      Serial.printf("Humidity above %.1f%%! Fan 2 ON\n", HUM_THRESHOLD);
    }
    int speed = map((int)round(maxHum * 10), (int)round(HUM_THRESHOLD * 10), (int)round((HUM_THRESHOLD + 20)*10), 128, 255);
    speed = constrain(speed, 128, 255);
    ledcWrite(fanChannel2, speed);
  } else if (fan2On) {
    fan2On = false;
    ledcWrite(fanChannel2, 0);
    unsigned long duration = (millis() - fan2Start) / 1000;
    Serial.printf("Humidity normalized. Fan 2 OFF. Duration: %lus\n", duration);
  }
}

void readSensors() {
  for (uint8_t i = 0; i < 2; i++) {
    tcaSelect(i);
    sensors_event_t humEvent, tempEvent;
    aht.getEvent(&humEvent, &tempEvent);
    float pressure = bmp.readPressure() / 100.0F;
    DateTime now = rtc.now();

    sensors[i].temp = tempEvent.temperature;
    sensors[i].hum = humEvent.relative_humidity;
    sensors[i].press = pressure;
    sensors[i].timeStr = String(now.hour()) + ":" + String(now.minute()) + ":" + String(now.second());

    Serial.printf("Sensor %d | Temp: %.2f°C | Hum: %.2f%% | Press: %.2f hPa | Time: %s\n",
                  i + 1, sensors[i].temp, sensors[i].hum, sensors[i].press, sensors[i].timeStr.c_str());
  }
}

String buildUIDString(uint8_t *uid, byte uidSize) {
  String s = "";
  for (byte i = 0; i < uidSize; i++) {
    if (uid[i] < 0x10) s += "0";
    s += String(uid[i], HEX);
    if (i < uidSize - 1) s += ":";
  }
  s.toUpperCase();
  return s;
}

bool isAuthorized(const String &uidstr) {
  for (int i = 0; i < AUTH_COUNT; ++i) {
    if (uidstr.equalsIgnoreCase(String(authorizedUIDs[i]))) return true;
  }
  return false;
}

void checkRFID() {
  // Non-blocking check for a new RFID card
  if (!mfrc522.PICC_IsNewCardPresent()) return;
  if (!mfrc522.PICC_ReadCardSerial()) return;

  String uid = buildUIDString(mfrc522.uid.uidByte, mfrc522.uid.size);
  lastTagUID = uid;
  lastTagTime = millis();

  Serial.print("RFID tag detected: ");
  Serial.println(uid);

  if (isAuthorized(uid)) {
    lastTagResult = "AUTHORIZED - UNLOCKED";
    Serial.println("Authorized tag! Unlocking solenoid...");
    startSolenoid();
  } else {
    lastTagResult = "UNAUTHORIZED - DENIED";
    Serial.println("Unauthorized tag. Access denied.");
  }

  mfrc522.PICC_HaltA(); // stop reading
  mfrc522.PCD_StopCrypto1();
}

void handleRoot() {
  // Build web dashboard HTML with sensor, fan, and RFID/lock info
  String html = "<!DOCTYPE html><html><head><title>ESP32 Smart Env System</title>";
  html += "<meta name='viewport' content='width=device-width, initial-scale=1'>";
  html += "<style>body{font-family:Arial;text-align:center;} .sensor{border:1px solid #333;padding:10px;margin:10px;display:inline-block;} .ok{color:green}.warn{color:red}</style>";
  html += "</head><body><h2>Smart Environmental Dashboard</h2>";

  for (int i = 0; i < 2; i++) {
    html += "<div class='sensor'>";
    html += "<h3>Sensor " + String(i + 1) + "</h3>";
    html += "Temp: " + String(sensors[i].temp, 2) + " °C<br>";
    html += "Hum: " + String(sensors[i].hum, 2) + " %<br>";
    html += "Pressure: " + String(sensors[i].press, 2) + " hPa<br>";
    html += "Time: " + sensors[i].timeStr + "<br><hr>";

    if (sensors[i].temp > TEMP_THRESHOLD)
      html += "<b class='warn'>Temperature above threshold! Fan 1 ON</b><br>";
    else
      html += "<b class='ok'>Temperature normal</b><br>";

    if (sensors[i].hum > HUM_THRESHOLD)
      html += "<b class='warn'>Humidity above threshold! Fan 2 ON</b><br>";
    else
      html += "<b class='ok'>Humidity normal</b><br>";

    html += "</div>";
  }

  // RFID & lock status
  html += "<div class='sensor'><h3>RFID / Lock</h3>";
  html += "Last Tag: " + lastTagUID + "<br>";
  html += "Result: " + lastTagResult + "<br>";
  html += "Last Seen: " + String((lastTagTime==0) ? String("never") : String((lastTagTime/1000)) + "s since boot") + "<br>";
  html += "Lock: " + String(solenoidActive ? "UNLOCKED" : "LOCKED") + "<br>";
  if (solenoidActive) {
    unsigned long elapsed = (millis() - solenoidStart) / 1000;
    html += "Unlock elapsed: " + String(elapsed) + "s<br>";
  }
  html += "</div>";

  html += "<script>setTimeout(()=>{location.reload();},1500);</script>";
  html += "</body></html>";

  server.send(200, "text/html", html);
}

void setup() {
  Serial.begin(115200);
  delay(200);

  Wire.begin(21, 22);

  // OLED
  if (!display.begin(OLED_ADDR, true)) {
    Serial.println("OLED not found!");
    while (1);
  }
  display.clearDisplay();
  display.setTextSize(1);
  display.setTextColor(WHITE);
  display.setCursor(0, 0);
  display.println("Initializing...");
  display.display();

  // RTC
  if (!rtc.begin()) while (1);
  if (rtc.lostPower()) rtc.adjust(DateTime(F(__DATE__), F(__TIME__)));

  // PWM for fans
  ledcSetup(fanChannel1, freq, resolution);
  ledcSetup(fanChannel2, freq, resolution);
  ledcAttachPin(FAN1_PIN, fanChannel1);
  ledcAttachPin(FAN2_PIN, fanChannel2);
  ledcWrite(fanChannel1, 0);
  ledcWrite(fanChannel2, 0);

  // Solenoid pin
  pinMode(SOL_PIN, OUTPUT);
  digitalWrite(SOL_PIN, LOW); // default locked

  // Sensors: Check both channels on multiplexer
  for (uint8_t i = 0; i < 2; i++) {
    tcaSelect(i);
    if (!aht.begin()) Serial.printf("AHT20 %d not found!\n", i);
    if (!bmp.begin(0x76)) Serial.printf("BMP280 %d not found!\n", i);
  }

  // RFID init (SPI)
  SPI.begin(); // SCK=18, MOSI=23, MISO=19 default
  mfrc522.PCD_Init();
  Serial.println("RFID reader initialized.");

  // Start Access Point
  WiFi.softAP(ssid, password);
  delay(100);
  IPAddress IP = WiFi.softAPIP();
  Serial.print("AP Started! Connect to SSID: ");
  Serial.println(ssid);
  Serial.print("AP IP address: ");
  Serial.println(IP);

  // Webserver
  server.on("/", handleRoot);
  server.begin();
}

void loop() {
  server.handleClient();

  // Read sensors and control fans
  readSensors();
  controlFans();

  // Check RFID tags (non-blocking)
  checkRFID();

  // If solenoid active, auto-stop after UNLOCK_DURATION_MS
  if (solenoidActive && (millis() - solenoidStart >= UNLOCK_DURATION_MS)) {
    stopSolenoid();
  }

  // Update OLED
  display.clearDisplay();
  display.setCursor(0, 0);
  for (int i = 0; i < 2; i++) {
    display.printf("S%d T:%.1fC H:%.1f%%\n", i + 1, sensors[i].temp, sensors[i].hum);
  }
  display.println();
  display.printf("RFID: %s\n", lastTagUID.c_str());
  display.display();

  delay(900); 
}